\documentclass[ebook,12pt,oneside,openany]{memoir}
\usepackage[utf8x]{inputenc}
\usepackage[english]{babel}
\usepackage{url}
\usepackage{amsthm}
\usepackage{color}

\usepackage{glossaries}
\makenoidxglossaries

\newglossaryentry{asymmetric cryptographic system}{name={asymmetric cryptographic system}, description={Asymmetric cryptography, or public-key cropytography is a cryptographic system that uses pairs of keys: public keys which may be disseminated widely, and private keys which are known only to the owner. The generation of such keys depends on cryptographic algorithms based on mathematical problems to produce one-way functions. Effective security only requires keeping the private key private; the public key can be openly distributed without compromising security.\url{https://en.wikipedia.org/w/index.php?title=Public-key_cryptography&oldid=877579180}}}
\newglossaryentry{digital signature}{name={digital signature},description={A digital signature is a mathematical scheme for verifying the authenticity of digital messages or documents. A valid digital signature gives a recipient reason to believe that the message was created by a known sender, that the sender cannot deny having sent the message and that the message was not altered in transit. They can be seen as cryptographic commitments in which the message is not hidden.\url{https://en.wikipedia.org/w/index.php?title=Digital_signature&oldid=876680165}}}
\newglossaryentry{cryptographic commitment}{name={cryptographic commitment}, description={A cryptographic commitment allows one to commit to a chosen value while keeping it hidden to others, with the ability to reveal the committed value later.\url{https://en.wikipedia.org/w/index.php?title=Commitment_scheme&oldid=842802201}}}

\title{Hacking the Lightning Network - A protocol to scale Bitcoin [Draft]} 
\author{Rene Pickhardt}

\begin{document}
\maketitle

\newpage
This book is open source and licensed under the \textit{Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International} license. You may find a copy of the license in the git repository of this book\footnote{\url{https://github.com/renepickhardt/the-lightning-network-book/LICENCE}} or on the homepage of Creative Commons.\footnote{\url{https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode}}

For the attribution you have to link to my homepage \url{https://www.rene-pickhardt.de}, my youtube channel: \url{https://www.youtube.com/user/RenePickhardt} and the git repository of this book at: \url{https://github.com/renepickhardt/the-lightning-network-book}. Obviously, you have to state my name Rene Pickhardt as the author.

\textbf{Consider financially supporting my book writing effort!}

Since this is an open source effort, I rely on the support of the community. In order to be able to work full time on this book, I need a budget of 21.21212121 BTC (with current exchange rates).

Donate using Bitcoin via: \url{https://tallyco.in/s/lnbook/} or fiat money at:  \url{https://patreon.com/renepickhardt}

\newpage
\tableofcontents
\newpage

\newcommand{\problem}[1]{\textbf{Problem: #1}}
\newcommand{\todo}[1]{\textcolor{blue}{\textbf{TODO}: #1}}

% following: http://web.mat.bham.ac.uk/R.W.Kaye/latex/thm.pdf
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}{Lemma}[chapter]
\theoremstyle{remark}
\newtheorem{remark}{Remark}[chapter]
\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
\theoremstyle{remark}
\newtheorem{example}{Example}[chapter]

\chapter{Introduction}
This book is a guide to understanding the Lightning Network as a technology to solve the scalability problem of Bitcoin.
It will first introduce the basic concepts of the Bitcoin protocol.
We will only make use of applied cryptography on a high level without the mathematical details.
Therefore basically no cryptographic knowledge is needed to be able to follow through this book.
For the sake of completeness some of the cryptographic details will be stated in the appendix.
Thus the Bitcoin section should be understandable by any computer science (or similar) undergraduate student.
As the Lightning Network is built on top of Bitcoin the rest of the book should be easily understandable by the same audience.
We conclude the first chapter by looking at some fundamental issues with Bitcoin as a payment system and explain the necessity for the Lightning Network.

We continue by explaining the theory and construction of the Lightning Network.
We will understand how to construct payment channels via Revocable Sequence Maturity Contracts and how to solve the routing issues via Hashed Time Locked Contracts.
These two forms of smart contracts allow for the Blockchain to be transformed from a transaction layer for payments to an enforcing layer of those contracts.
Similar to the real world, most contracts will never have to be enforced via a court ruling but are negotiated bilaterally between consenting parties.
In the same sense, we will understand that the Lightning Network reduces the load of the Bitcoin Network significantly by transforming it to be a contract enforcing layer instead of a value transaction layer.

After we understand the core contracts that enable the Lightning Network, we will look at the technologies to define a properly working protocol.
We will study the transport layer with its Sphinx mix format and Onion routing first and move on to the gossip protocol which enables the creation of a peer to peer network.

After we understand the technical foundations of the Lightning Network, a practical guide is given.
We look at the current wallets, implementations and tools for developers.
We create some small Lightning Network applications to demonstrate how easy it becomes with the help of the Lightning Network to accept Bitcoin payments.

Finally, we look at some of the more advanced topics of the Lightning Network.
These are mainly relevant for researchers and developers who want to improve the protocol.
We decided to include these topics because it seems plausible that users of the Lightning Network gain a clear picture of current trends and potential future enhancements. 

One core principle of this book is that we introduce new concepts by formulating problem statements first. We will then try to understand why these problems existed and how the technologies in this book will be able to solve those problems. In many cases, we will derive more specific problems which we will tackle in a similar fashion.

\chapter{Bitcoin}
\section{Introduction to Electronic Cash}
\problem{How can we create a digital form of cash?}
With the invention of the micro controller which lead to the development of computers, the Internet and smart phones, we have seen that many things that existed physically now exist in a digital version too.
Examples could be:
\begin{itemize}
\item Photographs, video recordings and music tapes.
\item Books, newspapers and other print publications.
\item Postal services for sending mail.
\item Archives and libraries.
\end{itemize}

Also a lot of communication has become digitized with services like email or instant messaging.
It seems that a huge reason for society to adopt a technological breakthrough is that in many cases digital goods are more convenient than their physical counterparts.
Take paper publications as an example: While it might be very convenient to carry around one book, it is hardly practical to carry around your entire library.
With modern electronic readers, it is possible to access the world's most extensive collection of textbooks on a single device.
One can even easily store the entire Wikipedia - which as an encyclopedia is larger than any other encyclopedia that has previously existed - on a small nano SD card.
Remember such an SD card is smaller than your thumbnail.

With regard to cash, we can see a similar trend.
Due to its scarcity gold served as one of the first universally accepted materials to serve as a currency.
However, using gold was not very practical as it is a heavy material and cannot be split easily.
Physical coins and bills (which in the beginning were backed by gold) emerged.
This form of cash is still used in all major countries of the world.\footnote{although currency nowadays is no longer backed by gold.}
Similarly to carrying around a single book, it might be highly convenient to carry around a 20 Euro\footnote{or whatever local currency you prefer} bill in order to buy some groceries. However we hardly see people carrying around 1000 times as much in order to buy a car or even more bills to buy a house.
Physical money in large quantities seems to be too cumbersome. 
The traditional banking sector and financial industry have come up with solutions like wire transfer or cheques.
Also, we can observe the emergence of online banking, credit cards and online money transfer services.
From a perspective of convenience, these services can be seen as a digital form of cash and are similarly convenient for the user like a digital book.

However, we should state that while the digital solutions which the financial industry provided might be convenient, they cannot - in fact, they must not - be seen as a real form of cash.
Physical cash in the form of coins and bills is supposed to be yours if you have it in your pocket.\footnote{Technically in most countries the notes and coins belong to the country which issued the cash. 
However you are entitled to the monetary value printed on those bills. As long as the value of the notes is preserved, you can be sure that you are able to spend your cash as long as others accept it.}
The digital alternatives, however, only exist virtually on some computer.
From a technical point of view they are just entries in a third party's database.
Thus, they are based on trusting this third party.
If your digital cash service provider decides to deny you access to your funds or run away with your money, there is basically nothing you can do.\footnote{Of course in most jurisdictions there is the legal system preventing them from stealing your money.}
Such a scenario can easily happen as we have seen with the bankruptcy of the famous bank Lehman Brothers in the summer of 2008. Many people that trusted their cash to this bank lost a fortune.
While we have to be fair and attest that it was certainly not the fault of their digital and virtual cash systems that they filed for bankruptcy, we see that trusting a bank to have a digital form of cash removes the most important property of cash.
The fact that you (and only you) will own it.
But the reason banks existed was not only to be a provider of a digital form of cash.
They already existed before the digital age because people did not want to carry around vast amounts of money.

So the question remains: Can there be a better form of digital cash in comparison to the solution provided by the traditional banking industry? 

Similarly to our example of e-books and physical cash (which we carry around with us) this form of digital or electronic cash should be stored on the digital device of the user.
Thus, it becomes just a piece of information.
In this way the user is not dependent on a trusted third party.\footnote{Of course as Bitcoin and Lightning Network developers we should be aware of the fact that we still trust the hardware producers, the software of our operating system and the consensus mechanisms of the network and protocol.}

However, computers and digital services seem to have a fundamental property that might make them useless for electronic cash systems.
Information can easily be duplicated by copy and pasting.
We remember that gold was used as one of the first mediums of exchange since it could not be duplicated.

To emphasize this issue again: A physical bill is actually transferred when making a payment. In contrast when spending a digital coin - as a piece of information - it can just be copied and duplicated.
The recipient has no chance of knowing that the sender actually deleted the coin.
If the sender did not delete the coin, the sender would be able to spend the coin again by copying the information to another person.
This process is called double spending.
Obviously, double spending sabotages the property that cash should act as a store of value. When the supply is infinite, a single coin becomes worthless. 

We can conclude that electronic cash is only useful if we solve the problem of double spending and create a limited supply of coins.

One obvious solution is a central authority or custodian who knows who owns which coins, and allows cash transactions only if the sender has enough cash.
While this solution works and is already implemented by traditional banks, it does not solve our desire that we carry around our electronic coins in our devices and - even worse - we still need to trust third-party services with all the risks that we have experienced with the collapse of Lehman Brothers.

Luckily in late 2008 a person or group under the pseudonym Satoshi Nakamoto published the Bitcoin paper.
This major technological breakthrough showed the world how it would be possible to create a decentralized form of electronic cash.
in which every participant stores access to their own funds and copying those coins does not mean duplicating them (as only one copy can be spent).

\subsection{Electronic coins as chains of digital signatures}
\problem{How do you claim ownership and authenticity of a digital good or a piece of information?}
\todo{Definately rethink the approach for this section. Also in the above chapter it might not have been wise to already introduce the double spending problem.}
By the end of the day cash is about ownership.
Therfore when creating an electronic cash system we have to be able to ascribe ownership of digital information.
Also it has to be possible to verify the authenticity of electronic cash in a similar fashion as one wants to able to verify the authenticity of a bank note.
Interestingly in the digital world it becomes significantly harder to fake an electronic coin in comparison to a physical banknode as we will understand at the end of this section.
As electronic cash is supposed to be a piece of information we can look in the field of computer science how ownership and authenticity of a piece of information is being claimed.
The standard procedure would be to make use of \gls{digital signature}s which can be seen as a very special case of a \gls{cryptographic commitment}.
Digital signatures will also be the method of choice for us to create electronic cash.

\problem{How do digital signatures work?}
A well known method to create digital signatures is by using an \gls{asymmetric cryptographic system}.
Despite the fact that modern cryptography involves quite some advanced mathmatical theory and computer science I want to encourage you to stick with me in this section.
Here we will just use this powerfull tool as a blackbox and describe its properties which should be easy to understand even for people who have always had trouble with mathematics.
In the appendix we give some mathematical and technical background about elliptic curve cryptography and about how and why it actually works.

In its simplest form an asymmetric cryptographic system consists of two keys which by convention are called the \textbf{private} and the \textbf{public key}.
From a computer science perspective each key is just a  piece of information encoded as a bitstring or from mathematic perspective it each key is just a number.
Due to some amazing mathmatical properties these keys turn out to be extremly usefull and have a (surpringly?) asymmetric relation to each other.
Hence the name asymmetric cryptographic system.

The three most important properties are as follows:
\begin{enumerate}
\item We can easily compute the public key from a private key.
However the other way around is extremly hard to compute.
In this context \textbf{easy} means that there is a well known algorithm and method to do this computation and that the computation also takes very little time.
On the contrast \textbf{hard} means that there might be a well known algorithm\footnote{for example brute forcing by systematically trying all values for a private key and computing the corresponding public key and check if it is the public key that we started with} but it is not feasable\footnote{actually it would be more accurate to say that it is highly  unlikely} to do this with one or even a cluster of modern computers within a reasonable time intervall. \todo{break up into sentences.}
\item With the help of the public key one can easily encrypt a message.
This encrypted message can then easily be decrypted with the help of the private key.
Remember the private key is hard to derive from the pulic key.
So we already see where the names come from.
A person can publish their public key and everyone else can easily compute an encrypted message.
This message can only easily be accessed (decrypted) if the private key is known.
That is why it is suggested to keep the private key as private and as  secrete as possible.
The main strenght of this property is that once such a keypair exists it is sufficiant to keep a small piece of information secure and secrete (the private key) in order to keep large amounts of information secrete by encrypting it with the help of a private key.
\item Given a piece of information and a private key one can easily compute a digital signature.
  Any person who has access to this piece of information, the signature and the public key can easily verify that this signature was computeded with the private key from that particular piece of information.
  If only a single bit in the information was changed after the signature was computed it cannot be verified with the public key anymore.
  As with the first two properties digital signatures are asymmetric in the sense that it is very hard to produce a valid signature for a message and a private key if only the public key is known.
  It is considered save to assume that the owner of the private (and thus also the public) key is indeed the authentic person to have created that message.
  But even more crazy due to the asymmetric nature it is almost impossible to forge a digital signature.
\end{enumerate}

\todo{somehow conclude that all these methods are used to controll information.}

\todo{INCLUDE GRPHAIC showing from private to public is easy and way back is difficult. Also show encryption and signature verifying mechanics}

The third property might seem rather abstract and useless at first but it is the property which leads to electronic cash and and cryptographic currencies.
While there is a little bit more cryptographic theory involved in creating cryptographic currencies this one is probably the most important building block.

\example{Lets assume we have the message: \textit{I am a proud supporter of the Lightning Network book} I can use the private key of the bitcoin from the fundraiser of this book \textbf{1GZx8tWgDd21Rd8b1QdMrzdZGHgyfVkzaD} to compute a signature: \todo{do the computation!}.
Now with the bitcoin address wich is almost a public key, the message and the signature you can verify that it was indeed the owner of the private key of that Bitcoin address who provided a signature to the message.
If the message will be changed by adding the missing point at the end of message to \textit{I am a proud supporter of the Lightning Network book.} it will produce the following signature: \todo{compute it!} which as can be seen lookes completely different in comparison to the first signature.
If I use the private keys for a different bitcoin address of mine for example {1CWtSk58d3rN1R3oGwMobJ6Ets9E2gvPj5} I can produce the signatures A and B for the first and second message. The signatures again look very different since they now belong to a different public and private key pair. Still with the second Bitcoin address anyone can verify them.}

While this example is nice in the sense that one can certainly prove ownership of a bitcoin address in most cases one doesn't want to prove that ownership explicitely.
Actually the oposite is true. Many people who use Bitcoin want to stay anonymous. 
However we need to have a mechanism to prove ownership of coins in order for others to be able to check if they actually gain new coins if we claim to transfer them

\todo{improve example from wording (basically rewrite it and create pictures to depict the situation.}
\example{Rene decides to issue a new electronic coin called renecoin.
  He does so by creating the message \textit{This is 1 renecoin.} and signing it with his private key which belongs to his bitcoinaddress.
  He wants to give this coin to Alice.
  He does this by extending the message.
  \textit{This is 1 renecoin. It is transfered to Alice.}
  Again he computes the signature to this message.
  Everyone who believes in renecoin can now see and verify that this electronic coin really belongs to alice by checking the Signature.
  If Alice wants to transfer the coin to somone else she can extend the message and sign the extended message.
  \textit{This is 1 renecoin. It is transfered to Alice. It is transfered to Bob.}
  This new message is now signed by Alice's key and everyone can verify that Bob is the real owner.
  We can see that there is a chain of Owners (Rene, Alice and Bob) and a chain of digital Signature (Rene's signature, Alice Signature).
  The chain of signatures is always one element shorter as the chain of owners.
  Besides the last entry of the list of owner all other entries have to match exactly.
  In this way we have created an electronic coin which can only be transfered to another person if the owner can provide a valid signature for the transfer message.}


In fact if Mallory wanted to steal the coin from Alice before Alice transfered it to Bob this would not work.
In order to change the owner the message that Rene signed would have to be extended. 
\textit{This is 1 renecoin. It is transfered to Alice. It is transfered to Mallory.}
However the chain of digital signatures (Rene's signature, Mallory's signature) Does not fit the chain of owners (Rene, Alice, Mallory)
That is why everyone would know that this message is not valid (even though it has a propper signature) no one would accept the coin from Mallory if she were to transfere it again.
On the other hand since Alice takes good care of her private key Mallory would not be able to produce a signature from Alice private key.

While it is tempting to think that we already have created a great form of electronic cash with these two lists of owners and digital signatures it turns out that this form of electronic cash has one severe problem.

\problem{What happens if Alice also gives the coin to Charly and not only to Bob?}
Assume Alice produces a valid signature for the message \textit{This is a renecoin. It is transfered to Alice. It is transfered to Charlie}.
She will be able to produce such a signature as she knows her private key.
We would now have a chain of owner (Rene, Alice, Charlie) and a chain of signature (Rene, Alice) as well as another chain of owners (Rene, Alice, Bob) and another chain of signatures (of which alice signature would be looking different than in the first case) (Rene, Alice)
In both cases Charlie and Bob can verify that they have been given 1 renecoin from Alice.
However Rene has only issued one coin.
Alice could spend this coin even more frequently.
Thus, our electronic renecoins would never have the chance to be a store of value as the supply can be extended arbitrarily.

The described process is called the \textbf{double spending problem} \todo{add glossary entry}.
It can be easily mitigated by using a central authority - for example rene - that signs all transfer messages.
However that would make it risky for people to use renecoin as everyone would have to trust rene to act honestly.
Luckily in 2008 Satoshi Nakamoto published his solution to the problem which he called Bitcoin a peer to peer electronic cash system.
It used a concept called proof of work which was copied from Adam Back's hashcash in order to get rid of the central authority. 

While we explain the proof of work mechanism in the next section we already


\todo{probably remove rest of this section}
We have seen that the desired form of electronic cash would exist as a digital file on everyones computer without a central mint or custodian being involved.
Besides the previously introduced problem of double spending there are also the questions of ownership and authenticity of electronic coins.
Note that it is not sufficient to say that you own a coin because the file which stores the information is placed on your computer.
Assuming that the double spending problem has already been solved we realize that such a file might exist on several computers.
This shall serve as a counter argument that 

\section{Proof of Work and Blockchain}

\section{Scalability issues of blockchain technologies}
\chapter{Lightning Network}
\section{Basic properties of the Lightning Network}
\section{Payment Channels via Revocable Sequence Maturity Contracts}
\section{Enabeling Routing via Hashed Time Locked Contracts}
\section{Transport layer: Sphinx Routing to increase privacy}
\section{Peer to Peer layer: The gossip protocol}
\section{Payment requests and BOLT11 invoices}
\section{Basics of Lightning Technology}
\chapter{Practical guide}
\section{Lightning Wallets}
\section{Lightning Nodes}
\section{Lightning Application Development}
\section{Useful Applications and Tools}
\chapter{Advanced Topics}
\section{Channel management}
\section{Autopilots}
\section{Securing your Lightning Network node}
\section{Pitfalls with concurrent requests}
\section{Eltoo payment channels}
\section{Channel factories}
\section{RGB protocol and colored coins}
\section{Rendezvous routing to hide the recipient}
\section{Risks}
\subsection{Hot Wallet Risk}
\subsection{Backup dilemma}
\subsection{Denial of Service attacks}
\begin{itemize}
\item Spam HTLCs to block channels
\item Spam the blockchain
\end{itemize}
\chapter{Controversial topics}
\section{Consequences of decentralization}
\section{Custodial Services, Lightning hubs and banks}
\section{Privacy and regulatory challenges}
\section{Consensus, Forking and Altcoins}


\appendix
\chapter{Cryptography}
\section{ECDSA}

Once upon a time\ldots This document shows how you can get ePub-like formatting in \LaTeX{} with the \verb|memoir| document class. You can't yet export directly to ePub from writeLaTeX, but you can download the source and run it through a format conversion tool, such as \verb|htlatex| to get HTML, and then go from HTML to ePub with a tool like Sigil or Calibre. See \url{http://tex.stackexchange.com/questions/16569} for more advice. And they lived happily ever after.

\appendix
\section{Contributers}
In the order of merging the pull requests:
\begin{itemize}
\item vv01f
\item adamjonas
\item billygarrison
\item gchaincl
\end{itemize}

\section{Donors}
In the temporal order of donations:
\begin{itemize}
\item import data import from https://tallyco.in/a/1GZx8tWgDd21Rd8b1QdMrzdZGHgyfVkzaD/


\end{itemize}

\glsaddall

Some of the glossary terms are taken from the English Wikipedia and might be adopted and modfied. These termes are indicated by the proper attribution to the Wikipedia article as a link at the end of the respecitve entry these entries are - in opposition to the remainder of the book - licensed as CC-BY-SA-3.0. In case they have been modified by by there will be a star (*) at the end of the URL

\printnoidxglossaries

\end{document}
